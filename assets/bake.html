<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bake Cities • Connect66</title>
    <link rel="stylesheet" href="./assets/styles.css" />
  </head>
  <body>
    <div class="card" style="max-width:900px; margin: 24px auto;">
      <div class="header">
        <h2>Bake cities.baked.json</h2>
        <span class="badge" id="progress">0/0</span>
      </div>
      <p>Click “Bake Now” to geocode <code>assets/cities.raw.json</code> and generate a downloadable <code>cities.baked.json</code>. Upload the file to your repo in <code>/assets</code>, replacing the placeholder.</p>
      <div style="display:flex; gap:8px; margin-bottom: 12px;">
        <button class="btn" id="bakeBtn">Bake Now</button>
        <a class="btn" id="downloadLink" style="display:none;" download="cities.baked.json">Download baked file</a>
      </div>
      <div class="hint">Uses OpenStreetMap Nominatim (1 request/sec). Keep this tab open until it completes.</div>
      <pre id="log" style="margin-top:12px; white-space:pre-wrap; max-height: 50vh; overflow:auto; background:#f9fafb; padding:12px; border-radius:8px;"></pre>
    </div>
    <script>
      const progressEl = document.getElementById('progress');
      const logEl = document.getElementById('log');
      const dl = document.getElementById('downloadLink');
      const btn = document.getElementById('bakeBtn');

      function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

      async function geocodeCity(city, state) {
        const q = encodeURIComponent(`${city}, ${state}, USA`);
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${q}&addressdetails=1&limit=1`;
        try {
          const res = await fetch(url, { headers: { "Accept-Language": "en" } });
          if (!res.ok) return null;
          const data = await res.json();
          if (Array.isArray(data) && data.length > 0) {
            return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
          }
        } catch(e) {}
        return null;
      }

      async function bake() {
        btn.disabled = true;
        const raw = await (await fetch('./assets/cities.raw.json')).json();
        const out = [];
        let done = 0;
        progressEl.textContent = `0/${raw.length}`;
        for (const row of raw) {
          const coords = await geocodeCity(row.city, row.state);
          if (coords) {
            out.push({ ...row, ...coords });
            logEl.textContent += `✓ ${row.city}, ${row.state} -> ${coords.lat.toFixed(5)}, ${coords.lon.toFixed(5)}\n`;
          } else {
            logEl.textContent += `✗ ${row.city}, ${row.state} -> not found\n`;
          }
          done++;
          progressEl.textContent = `${done}/${raw.length}`;
          await sleep(1100);
        }
        // Prepare download
        const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        dl.href = url;
        dl.style.display = 'inline-block';
      }

      document.getElementById('bakeBtn').addEventListener('click', bake);
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect66 Gateway Towers — Statewide Route 66 Infrastructure for the 2026 Centennial</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --brand:#0f172a;   /* deep slate */
      --accent:#f59e0b;  /* amber */
      --ink:#111827;     /* text */
    }
    *{box-sizing:border-box}
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--ink); }

    /* Brand header */
    .brand { background: linear-gradient(135deg, var(--brand), #1f2937); color:#fff; border-bottom:4px solid var(--accent); }
    .brand-inner { max-width: 1200px; margin: 0 auto; padding: 20px 16px; display:flex; gap:16px; align-items:center; }
    .logo { width: 56px; height: 56px; object-fit: contain; display:block; }
    .titles h1 { margin:0 0 6px; font-weight:800; letter-spacing:.2px; }
    .tagline { margin:0 0 10px; opacity:.95 }
    .pills { display:flex; flex-wrap:wrap; gap:8px; }
    .pill { background:#ffffff14; border:1px solid #ffffff33; color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; backdrop-filter: blur(2px); }

    /* Content & Map */
    .wrap { max-width:1200px; margin: 0 auto; padding: 16px; }
    #map { height: 74vh; min-height: 420px; border-radius: 16px; }

    /* Status + Controls */
    .hud { position: fixed; top: 12px; right: 12px; display:flex; flex-direction:column; gap:8px; z-index:1000; }
    .status, .panel {
      background:#fff; border:1px solid #ddd; padding: 8px 10px; border-radius: 8px; font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
    }
    .panel label { display:flex; gap:6px; align-items:center; cursor:pointer; }
    .panel .row { display:flex; gap:8px; align-items:center; }
    .btn { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; cursor:pointer; font-size:12px; }
    .btn:hover { background:#f9fafb; }

    /* Legend (population) */
    .legend { position: fixed; left: 12px; bottom: 12px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:10px; font-size:12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
    .legend .bar { width: 180px; height: 10px; background: linear-gradient(90deg, #c7d2fe, #1e3a8a); border-radius:6px; margin:6px 0; }
    .legend .labels { display:flex; justify-content:space-between; color:#374151; }

    @media (max-width: 640px){
      .brand-inner{flex-direction:column; align-items:flex-start}
      .logo{width:44px; height:44px}
    }
  </style>
</head>
<body>

  <!-- Brand header -->
  <header class="brand">
    <div class="brand-inner">
      <img class="logo" src="./assets/connect66-logo.svg" alt="Connect66" onerror="this.style.display='none'">
      <div class="titles">
        <h1>Connect66 Gateway Towers — Statewide Route 66 Infrastructure for the 2026 Centennial</h1>
        <p class="tagline">44 on-route communities delivering public Wi-Fi, heritage storytelling, ribbon-cuttings, and measurable tourism impact.</p>
        <div class="pills">
          <span class="pill"><span id="siteCount">44</span> sites</span>
          <span class="pill">statewide coverage</span>
          <span class="pill">shovel-ready</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Map -->
  <div class="wrap">
    <div id="map"></div>
  </div>

  <!-- Status + Controls -->
  <div class="hud">
    <div class="panel">
      <div class="row">
        <label><input type="checkbox" id="measureToggle"> Measure distance</label>
        <button class="btn" id="resetMeasure">Reset</button>
      </div>
      <div class="row">
        <label><input type="checkbox" id="popToggle" checked> Color by population (if available)</label>
      </div>
    </div>
    <div class="status" id="status">Loading…</div>
  </div>

  <!-- Population legend (shown only when we have population data) -->
  <div class="legend" id="legend" style="display:none;">
    <div><strong>Population</strong></div>
    <div class="bar"></div>
    <div class="labels"><span id="minPop">min</span><span id="maxPop">max</span></div>
  </div>

  <script>
    // ------- Helpers -------
    const R = 6371; // km
    const toRad = d => d * Math.PI / 180;
    function haversine(a, b) {
      const dLat = toRad(b.lat - a.lat), dLon = toRad(b.lon - a.lon);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s)); // km
    }
    // Nice color scale (light blue -> deep indigo)
    function popColor(min, max, val){
      if (!Number.isFinite(val) || max===min) return '#1e3a8a';
      const t = Math.max(0, Math.min(1, (val - min) / (max - min)));
      // interpolate HSL: 225deg (light) -> 222deg (dark), sat 90->95, light 80->30
      const h = 225 - 3*t, s = 90 + 5*t, l = 80 - 50*t;
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    // ------- Map setup -------
    const map = L.map('map').setView([35.5, -97.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    const statusEl = document.getElementById('status');
    const siteCountEl = document.getElementById('siteCount');
    const measureToggle = document.getElementById('measureToggle');
    const resetBtn = document.getElementById('resetMeasure');
    const popToggle = document.getElementById('popToggle');
    const legendEl = document.getElementById('legend');
    const minPopEl = document.getElementById('minPop');
    const maxPopEl = document.getElementById('maxPop');

    let markers = [];         // Leaflet markers
    let halos = [];           // color halos (circleMarkers) for population
    let points = [];          // [{city, state, lat, lon, population?}]
    let popMin = null, popMax = null;
    let measureSel = [];      // selected points for measurement
    let measureLine = null;

    // Try to load optional population mapping file and merge
    async function loadPopulation(){
      try {
        const r = await fetch('./assets/population.json');
        if (!r.ok) return {}; // optional file
        return await r.json(); // expected shape: { "Afton, OK": 1000, ... } or [{city, state, population}]
      } catch { return {}; }
    }

    function coercePopulation(popData, row){
      // Accept several formats:
      // 1) row.population already exists
      // 2) population.json as object map: "City, ST": number
      // 3) population.json as array of {city, state, population}
      if (Number.isFinite(row.population)) return row.population;
      if (Array.isArray(popData)) {
        const hit = popData.find(x =>
          (x.city ?? '').toLowerCase() === row.city.toLowerCase() &&
          (x.state ?? '').toLowerCase() === row.state.toLowerCase()
        );
        return hit ? Number(hit.population) : undefined;
      } else if (popData && typeof popData === 'object') {
        const key = `${row.city}, ${row.state}`;
        if (key in popData) return Number(popData[key]);
      }
    }

    function renderMarkers(){
      // Clear any existing
      markers.forEach(m => map.removeLayer(m)); markers = [];
      halos.forEach(h => map.removeLayer(h)); halos = [];

      const usePop = popToggle.checked && Number.isFinite(popMin) && Number.isFinite(popMax);

      const bounds = [];
      points.forEach(p => {
        const m = L.marker([p.lat, p.lon]).addTo(map)
          .bindPopup(`<strong>${p.city}, ${p.state}</strong><br>Lat ${p.lat.toFixed(5)}, Lng ${p.lon.toFixed(5)}${Number.isFinite(p.population) ? `<br>Population: ${p.population.toLocaleString()}` : ''}`);

        // distance picking
        m.on('click', () => {
          if (!measureToggle.checked) return; // normal behavior if not in measure mode
          measureSel.push(p);
          if (measureSel.length === 2) {
            drawMeasurement();
          } else {
            statusEl.textContent = `Selected: ${p.city}, ${p.state}. Pick another town…`;
          }
        });

        markers.push(m);
        bounds.push([p.lat, p.lon]);

        // population visual halo
        if (usePop && Number.isFinite(p.population)) {
          const halo = L.circleMarker([p.lat, p.lon], {
            radius: 10,
            stroke: false,
            fillOpacity: 0.70,
            fillColor: popColor(popMin, popMax, p.population)
          }

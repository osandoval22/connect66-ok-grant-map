<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect66 — OK Sequential Distances + Population</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --bg:#0b1420; --fg:#e7eefc; --muted:#9fb3c8; --panel:#0f1b2a; }
    * { box-sizing: border-box; }
    body { margin:0; display:flex; min-height:100vh; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:fixed; left:0; right:340px; top:0; padding:14px 16px; background:var(--bg); border-bottom:3px solid #f7a600; z-index:5;}
    header h1 { margin:0; font-size: clamp(1.05rem,2.2vw,1.6rem); }
    #map { position:absolute; top:62px; left:0; right:340px; bottom:0; }
    aside { position:fixed; right:0; top:0; bottom:0; width:340px; background:var(--panel); border-left:1px solid #233247; padding:12px 12px 16px; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 4px; }
    label, select { font-size:0.9rem; }
    select { background:#13243a; color:#e7eefc; border:1px solid #2a4060; border-radius:8px; padding:6px 8px; }
    #status { color:#ffd18b; font-size:0.9rem; margin:8px 0; }
    ol { margin:8px 0 0 18px; padding:0; }
    ol li { margin:6px 0; line-height: 1.25; }
    .small { color:var(--muted); font-size:0.9rem; }
    .total { margin-top:10px; font-weight:600; }
    .city-badge {
      display: inline-block;
      min-width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #222;             /* dark background */
      color: #fff;                  /* white text */
      border: 2px solid #ffd166;    /* yellow border */
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      line-height: 22px;
      box-shadow: 0 0 4px rgba(0,0,0,0.6);
    }
    .city-idx { filter: drop-shadow(0 1px 2px rgba(0,0,0,.45)); }
    .legend { position:absolute; left:12px; bottom:16px; background:#0f1b2a; color:#fff; padding:8px 10px; border-radius:8px; border:1px solid #233247; font-size:0.85rem; }
    .legend .swatch { display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:-2px; border-radius:3px; }
    .leaflet-tooltip.dist-label {
      background: rgba(0,0,0,0.72);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 6px;
      padding: 2px 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
      font-weight: 600;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Connect66 — Oklahoma Sequential Distances + Population</h1>
  </header>

  <div id="map"></div>
  <div id="legend" class="legend" style="display:none;"></div>

  <aside>
    <div class="row">
      <label><input type="checkbox" id="chkColor" checked /> Color by population</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="chkLabels" checked /> Show distance labels</label>
    </div>
    <div class="row">
      <label for="orderSel">Ordering:</label>
      <select id="orderSel">
        <option value="dataset" selected>Dataset sequence</option>
        <option value="west_east">Longitude: West → East</option>
        <option value="east_west">Longitude: East → West</option>
      </select>
    </div>
    <div id="status">Loading…</div>
    <div id="list"></div>
  </aside>

<script>
function haversine(lat1,lng1,lat2,lng2){
  const toRad=x=>x*Math.PI/180;
  const R=3958.8;
  const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function toNum(x){ return (x==null?NaN:Number(String(x).replace(/,/g,''))); }
function rel(p){ return p; }
function normName(s){
  return String(s||'').toLowerCase()
    .replace(/[.,()-]/g,' ')
    .replace(/\boklahoma\b|\bok\b|\bcity\b|\btown\b|\bvillage\b/g,'')
    .replace(/\s+/g,' ')
    .trim();
}
async function loadJSON(u){ const r=await fetch(u); if(!r.ok) throw new Error('fail '+u); return r.json(); }
async function loadPopIndex(){
  const raw=await loadJSON(rel('./assets/population.json')).catch(()=> ({}));
  const idx={};
  if(Array.isArray(raw)){
    for(const r of raw){
      const name=r.name||r.city||r.place||r.town||r.label;
      const val=toNum(r.population??r.pop??r.pop2020??r.estimate??r.count);
      if(name && Number.isFinite(val)&&val>0) idx[normName(name)]=val;
    }
  } else {
    for(const [k,v] of Object.entries(raw)){
      const val=toNum((v&&(v.population??v.pop??v.pop2020??v.estimate??v.count)) ?? raw[k]);
      if(Number.isFinite(val)&&val>0) idx[normName(k)]=val;
    }
  }
  return idx;
}

(async()=>{
  try{
    const [cities,popIndex]=await Promise.all([
      loadJSON(rel('./assets/cities.baked.json')).catch(()=>loadJSON(rel('./cities.baked.json'))),
      loadPopIndex()
    ]);

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect66 — Oklahoma Sequential Distances + Population</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --bg:#0b1420; --fg:#e7eefc; --muted:#9fb3c8; --panel:#0f1b2a; }
    * { box-sizing: border-box; }
    body { margin:0; display:flex; min-height:100vh; background:var(--bg); color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:fixed; left:0; right:340px; top:0; padding:14px 16px; background:var(--bg); border-bottom:3px solid #f7a600; z-index:5;}
    header h1 { margin:0; font-size: clamp(1.05rem,2.2vw,1.6rem); }
    #map { position:absolute; top:62px; left:0; right:340px; bottom:0; }
    aside { position:fixed; right:0; top:0; bottom:0; width:340px; background:var(--panel); border-left:1px solid #233247; padding:12px 12px 16px; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 4px; }
    label, select { font-size:0.9rem; }
    select { background:#13243a; color:#e7eefc; border:1px solid #2a4060; border-radius:8px; padding:6px 8px; }
    #status { color:#ffd18b; font-size:0.9rem; margin:8px 0; }
    ol { margin:8px 0 0 18px; padding:0; }
    ol li { margin:6px 0; line-height: 1.25; }
    .small { color:var(--muted); font-size:0.9rem; }
    .total { margin-top:10px; font-weight:600; }
    /* HIGH-CONTRAST number badges */
    .city-badge {
      display:inline-block; min-width:22px; height:22px; line-height:22px;
      border-radius:50%; background:#222; color:#fff;
      border:2px solid #ffd166; font-weight:700; font-size:13px; text-align:center;
      box-shadow:0 0 4px rgba(0,0,0,.6);
    }
    .city-idx { filter: drop-shadow(0 1px 2px rgba(0,0,0,.45)); }
    .legend { position:absolute; left:12px; bottom:16px; background:#0f1b2a; color:#fff; padding:8px 10px; border-radius:8px; border:1px solid #233247; font-size:0.85rem; }
    .legend .swatch { display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:-2px; border-radius:3px; }
    .leaflet-tooltip.dist-label {
      background: rgba(0,0,0,0.72); color:#fff; border:1px solid rgba(255,255,255,0.25);
      border-radius:6px; padding:2px 6px; box-shadow:0 2px 8px rgba(0,0,0,0.35);
      font-weight:600; font-size:12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Connect66 — Oklahoma Sequential Distances + Population</h1>
  </header>

  <div id="map"></div>
  <div id="legend" class="legend" style="display:none;"></div>

  <aside>
    <div class="row">
      <label><input type="checkbox" id="chkColor" checked /> Color by population</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="chkLabels" checked /> Show distance labels</label>
    </div>
    <div class="row">
      <label for="orderSel">Ordering:</label>
      <select id="orderSel">
        <option value="dataset" selected>Dataset sequence</option>
        <option value="west_east">Longitude: West → East</option>
        <option value="east_west">Longitude: East → West</option>
      </select>
    </div>
    <div id="status">Loading…</div>
    <div id="list"></div>
  </aside>

<script>
/* ---------- Utilities ---------- */
const rel = p => new URL(p, window.location.href).toString();
const toNum = v => Number(String(v ?? '').replace(/,/g,'').trim());
const haversineMi = (aLat,aLng,bLat,bLng) => {
  const R=3958.8, toRad=d=>d*Math.PI/180;
  const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
  const s=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
  return 2*R*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
};
const midpoint = (a,b) => [(a[0]+b[0])/2,(a[1]+b[1])/2];
const normName = s => String(s||'').toLowerCase()
  .replace(/[.,()-]/g,' ').replace(/\boklahoma\b|\bok\b|\bcity\b|\btown\b|\bvillage\b/g,'')
  .replace(/\s+/g,' ').trim();

async function loadJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error('Failed to load '+url+' ('+r.status+')'); return r.json(); }

/* Robust population loader (handles array or object formats) */
async function loadPopIndex(){
  const raw = await loadJSON(rel('./assets/population.json')).catch(()=> ({}));
  const idx = {};
  if (Array.isArray(raw)){
    for (const r of raw){
      const name = r.name || r.city || r.place || r.town || r.label;
      const val = toNum(r.population ?? r.pop ?? r.pop2020 ?? r.estimate ?? r.count);
      if (name && Number.isFinite(val) && val>0) idx[normName(name)] = val;
    }
  } else {
    for (const [k,v] of Object.entries(raw)){
      const val = toNum((v && (v.population ?? v.pop ?? v.pop2020 ?? v.estimate ?? v.count)) ?? raw[k]);
      if (Number.isFinite(val) && val>0) idx[normName(k)] = val;
    }
  }
  return idx;
}

/* color scale (simple quantiles) */
const COLORS=['#fee5d9','#fcae91','#fb6a4a','#de2d26','#a50f15'];
function quantizeScale(values){
  const v=values.filter(n=>Number.isFinite(n)&&n>0).sort((a,b)=>a-b);
  if(!v.length) return Object.assign(()=> '#3fa3ff',{breaks:null});
  const pick=q=>v[Math.floor(q*(v.length-1))];
  const bins=[pick(0.2),pick(0.4),pick(0.6),pick(0.8)];
  const f=x=>{
    if(!Number.isFinite(x)||x<=0) return '#666';
    if(x<=bins[0])return COLORS[0];
    if(x<=bins[1])return COLORS[1];
    if(x<=bins[2])return COLORS[2];
    if(x<=bins[3])return COLORS[3];
    return COLORS[4];
  };
  return Object.assign(f,{breaks:bins});
}

/* ---------- Main ---------- */
(async ()=>{
  const status = document.getElementById('status');
  try{
    const [cities, popIndex] = await Promise.all([
      loadJSON(rel('./assets/cities.baked.json')).catch(()=>loadJSON(rel('./cities.baked.json'))),
      loadPopIndex()
    ]);

    let raw = (Array.isArray(cities) ? cities : (cities.locations || cities.cities || []));
    raw = raw.map(r=>{
      const name = r.name || r.city || r.town || '';
      const pop  = popIndex[normName(name)];
      return {
        ...r,
        name,
        lat: Number(r.lat ?? r.latitude),
        lng: Number(r.lng ?? r.lon ?? r.longitude),
        population: (Number.isFinite(pop) && pop>0) ? pop : NaN
      };
    }).filter(p=>Number.isFinite(p.lat) && Number.isFinite(p.lng));

    if(!raw.length) throw new Error('No valid coordinates in assets/cities.baked.json');

    /* Map + layers */
    const map = L.map('map');
    const bounds = L.latLngBounds(raw.map(p=>[p.lat,p.lng]));
    map.fitBounds(bounds.pad(0.15));
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    const markers = L.layerGroup().addTo(map);
    const lines   = L.layerGroup().addTo(map);
    const labels  = L.layerGroup().addTo(map);

    const scale = quantizeScale(raw.map(p=>p.population));

    const orderSel = document.getElementById('orderSel');
    const chkColor = document.getElementById('chkColor');
    const chkLbl   = document.getElementById('chkLabels');

    const orderKeys = ['order','sequence','seq','index','idx','rank','position'];
    const hasOrderKey = orderKeys.find(k => raw.some(r => typeof r[k] !== 'undefined'));

    function sortPoints(mode){
      const a = raw.slice();
      if(mode==='dataset' && hasOrderKey) a.sort((x,y)=>(Number(x[hasOrderKey])||0)-(Number(y[hasOrderKey])||0));
      else if(mode==='east_west') a.sort((x,y)=>y.lng-x.lng);
      else a.sort((x,y)=>x.lng-y.lng);
      return a;
    }

    function redraw(){
      markers.clearLayers(); lines.clearLayers(); labels.clearLayers();

      const pts = sortPoints(orderSel.value);
      let total = 0;
      let html  = '<ol>';

      pts.forEach((p,idx)=>{
        /* Number badge — keep ABOVE everything */
        const numIcon = L.divIcon({
          className:'city-idx',
          html:`<div class="city-badge">${idx+1}</div>`,
          iconSize:[24,24],
          iconAnchor:[12,12]
        });
        L.marker([p.lat,p.lng],{
          icon:numIcon, interactive:false, pane:'markerPane', zIndexOffset:1000, opacity:1
        }).addTo(markers);

        /* Colored dot (population or default) */
        const fill = chkColor.checked ? scale(p.population) : '#3399ff';
        L.circleMarker([p.lat,p.lng],{radius:6,weight:1,color:'#0b1d31',fillColor:fill,fillOpacity:0.95})
          .bindTooltip(`${idx+1}. ${p.name}<br>Pop: ${Number.isFinite(p.population)?p.population.toLocaleString():'N/A'}`)
          .addTo(markers);

        if(idx<pts.length-1){
          const q = pts[idx+1];
          const d = haversineMi(p.lat,p.lng,q.lat,q.lng);
          total += d;
          L.polyline([[p.lat,p.lng],[q.lat,q.lng]],{color:'#ffd166',weight:3}).addTo(lines);
          if(chkLbl.checked){
            L.tooltip({permanent:true,direction:'top',className:'dist-label',offset:[0,-6]})
              .setLatLng(midpoint([p.lat,p.lng],[q.lat,q.lng]))
              .setContent(`${idx+1}→${idx+2}: ${d.toFixed(1)} mi`)
              .addTo(labels);
          }
          html += `<li><strong>${idx+1}→${idx+2}</strong> ${p.name} <span class="small">(pop: ${Number.isFinite(p.population)?p.population.toLocaleString():'N/A'})</span> → ${q.name} <span class="small">(pop: ${Number.isFinite(q.population)?q.population.toLocaleString():'N/A'})</span> <span class="small">(${d.toFixed(1)} mi)</span></li>`;
        }
      });

      html += '</ol><div class="total">Total (series): '+total.toFixed(1)+' mi</div>';
      document.getElementById('list').innerHTML = html;

      /* Legend */
      const el=document.getElementById('legend');
      if(scale.breaks){
        const b=scale.breaks;
        el.innerHTML = '<div><strong>Population</strong></div>'
          + `<div><span class="swatch" style="background:#fee5d9"></span> ≤ ${b[0].toLocaleString()}</div>`
          + `<div><span class="swatch" style="background:#fcae91"></span> ≤ ${b[1].toLocaleString()}</div>`
          + `<div><span class="swatch" style="background:#fb6a4a"></span> ≤ ${b[2].toLocaleString()}</div>`
          + `<div><span class="swatch" style="background:#de2d26"></span> ≤ ${b[3].toLocaleString()}</div>`
          + `<div><span class="swatch" style="background:#a50f15"></span> higher</div>`;
        el.style.display='block';
      } else el.style.display='none';
    }

    redraw();
    orderSel.addEventListener('change', redraw);
    chkColor.addEventListener('change', redraw);
    chkLbl.addEventListener('change', redraw);

    status.textContent = '';
  }catch(e){
    console.error(e);
    document.getElementById('status').textContent = 'Error: ' + e.message;
  }
})();
</script>
</body>
</html>
